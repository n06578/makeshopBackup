<?php
require_once $_ENV['PATH_LIB']."/openapi/openapi.validation.lib.html";
require_once $_ENV['PATH_LIB']."/oo_create.lib.html";
require_once $_ENV['PATH_FUNC']."/manager_admin.func.html";
require_once $_ENV['PATH_LIB'].'/smart_reserve.lib.html';
/* 입금확인 */
class OpenApiProcCpickOnlineOrder extends OpenApiProcess
{
	var $adminuser;
	var $process;
	var $license;
	var $oordercreate;
	var $priceexists;
	function OpenApiProcCpickOnlineOrder($adminuser, $license)
	{
		$this->__construct($adminuser, $license);
	}

	/**
	 * 생성자에서는 $this->localdb 사용 불가
	 * @param string $adminuser
	 * @param array $license
	 * @return void
	 */
	function __construct($adminuser, $license)
	{
		$this->adminuser = $adminuser;
		$this->license = $license;
	}

	function setDbObj($localdb, $slavedb = null)
	{
		$this->selectdb = (is_resource($slavedb)) ? $slavedb : $localdb;
		$this->localdb = $localdb;
	}

	function license()
	{
		return $this->license;
	}

	/**
	 * 처리할 타입 지정
	 * @param string $process
	 * @return void
	 */
	function setProcess($process = 'create')
	{
		$this->process = $process;
	}

	/**
	 * @return bool
	 */
	function commonValidate()
	{
		return true;
	}

	function depositPossible(){
		$this->deposit_passible = true;
	}

	/**
	 * 처리 로직 수행
	 * @return array
	 */
	function save()
	{
		switch ($this->process) {
			case 'create' :
				file_save_log("openapi_cpick_online_order_".date('Ymd'), "create_order request : ".json_encode($this->encodeUTF8($_POST)));
				return $this->handler();
		}

		return array();
	}

	/**
	 * 값 유효성 검증
	 * @param array $param
	 * @return array
	 */
	function validation($param)
	{
		$validation = OpenapiValidation::validation($param, array(
			'user_id' =>array('required'),
			'order_date' =>array('required'),
			'total_order_price' =>array('required', 'numeric'),
			'total_pay_price' =>array('required', 'numeric'),
			'paymethod' =>array('required'),
			'sender' =>array('required'),
			'phone' =>array('required'),
			'mobile' =>array('required'),
			'email' =>array('required'),
			'memo' =>array('required'),
			'post' =>array('required'),
			'address' =>array('required'),
			'address2' =>array('required'),
			'deli_price' =>array('required', 'numeric'),
			'receiver' =>array('required'),
			'receiver_mobile' =>array('required'),
			'receiver_phone' =>array('required'),
			'deli_msg' =>array('required'),
			'link_id' =>array('required'),

			'baskets.*.product_uid' => array('required', 'numeric'),
			'baskets.*.prd_option_uid' => array('required', 'numeric'),
			'baskets.*.stock' => array('required', 'numeric'),
			'baskets.*.price' => array('required', 'numeric'),
			'baskets.*.product_name' => array('required'),
			'baskets.*.option_name' => array('required'),
		));
		$result = array_merge($validation, $this->add_validation($param));
		return $result;
	}

	/**
	 * 값 유효성 추가 검증
	 * @param [type] $param
	 * @return array
	 */
	function add_validation($param)
	{
		$result = array();
		if (!isset($param['baskets'])) {
			return array('baskets는 하나 이상 등록이 필요합니다.');
		}
		return $result;
	}

	/**
	 * @return array
	 */
	function handler()
	{
		$return = Array();
		$return['datas']['result'] = false;
		$encode_data = $this->encodeEucKr($_POST['datas']);
		$validation = $this->validation($encode_data);
		if (count($validation) > 0) {
			$return['datas']['message'] = $validation;
			return $return;
		}

		$return['datas'] = $this->store($encode_data);
		return $return;
	}

	function createOrderCreateObj($ordernum)
	{
		$this->oordercreate = new OrderCreate($this->adminuser, $ordernum);
	}
	/**
	 * 데이터 처리
	 * @param array $param
	 * @return bool
	 */
	function store($encode_post)
	{
		$this->depositPossible();
		$param = array_merge($encode_post, $this->create_add_fields($encode_post));
		$users = $this->define_user($param);
		$this->create_order_handle($param, $users);
		updatelogs($param['ordernum'], "### 크픽 주문서 생성 ###");
		if($this->deposit_passible){
			$this->update_order_price($param);
			$this->update_stock_count($param);
		}
		file_save_log("openapi_cpick_online_order_".date('Ymd'), "create_order  data : ".json_encode($this->encodeUTF8($param))." user : ".json_encode($this->encodeUTF8($users)));
		$this->update_order_max_barcode($param['barcode']);

		return array(
			'result' => true,
			'ordernum' => $param['ordernum']
		);
	}

	function update_order_max_barcode($barcode)
	{
		$sql = "UPDATE `etc` set `order_max_barcode`='{$barcode}' where adminuser='{$this->adminuser}' limit 1 ";
		query($sql, $this->localdb);
	}

	function create_order_handle($param, $users)
	{
		$this->createOrderCreateObj($param['ordernum']);
		$this->create_basket_temp($param);
		$this->create_order_temp($param, $users);
		$this->create_order_msg_temp($param);
		$this->oordercreate->insert_tempdelivery(array(
			'tempid'            => $param['tempid'],
			'delivery_num'      => $param['delivery_num'],
			'user_id'           => $param['user_id'],
			'post'				=> $param['post'],
			'address'			=> $param['address'],
			'address2'			=> $param['address2'],
			'deli_price'		=> $param['deli_price'],
			'receiver'			=> $param['receiver'],
			'receiver_mobile'	=> $param['receiver_mobile'],
			'receiver_phone'	=> $param['receiver_phone'],
			'deli_msg'			=> $param['deli_msg'],
			'deli_type'         => 'KOR',
			'delicom' => ''
		));
		$this->oordercreate->set_order_data($this->define_set_order_data($param));
		$this->oordercreate->create_order_data();
	}

	function create_basket_temp($param)
	{
		if (is_array($param['baskets'])) {
			if($param['total_order_price'] != 0 || $param['total_pay_price'] != 0 || $param['deli_price'] != 0 ) $this->deposit_passible = false;
			foreach ($param['baskets'] as $index => $basket)
			{
				$baskets = array_merge(array(
					'tempid' => $param['tempid'],
					'delivery_num' => $param['delivery_num'],
					'link_id' => $param['link_id'],
					'stock_chk' => 'NOT',
					'basket_status' => $param['basket_status'],
					'smartpickup_store_uid' => $param['store_id']
				), $this->define_product($basket));
				$this->oordercreate->insert_temporderbasket($baskets);
				file_save_log("openapi_cpick_online_order_".date('Ymd'), "create_basket_temp : ".json_encode($this->encodeUTF8($baskets)));
			}
		}
	}

	function create_order_temp($param, $users)
	{
		$orders = array(
			'ordernum'          => $param['ordernum'],
			'tempid'            => $param['tempid'],
			'id'                => $param['user_id'],
			'is_member'         => $users['is_user']=="Y"?"MEMBER":"GUEST",
			'barcode'           => $param['barcode'],
			'sender'            => $users['sender'],
			'paymethod'         => $param['paymethod'],
			'paydata'           => '크픽 협찬 구매',
			'phone'             => $users['phone'],
			'mobile'            => $users['mobile'],
			'email'             => $users['email'],
			'pay_path'          => "WEB",
			'mem_language'      => "kor",
			'mem_type'          => ($users['mem_type']) ? $users['mem_type'] : "PERSON",
			'bank_name' 		=> $param['banker'],
			'banker' 			=> $param['banker'],
			'banker_account' 	=> $param['banker_account'],
			'link_url' 			=> $param['link_url'],
			'link_id'			=> $param['link_id'],
		);
		$this->oordercreate->insert_temporder($orders);
		file_save_log("openapi_cpick_online_order_".date('Ymd'), "create_order_temp : ".json_encode($this->encodeUTF8($orders)));
	}

	function create_order_msg_temp($param){
		$ordermsg = array(
			'ordernum'          => $param['ordernum'],
			'tempid'		=> $param['tempid'],
			'msg_type'		=> 'ORDER',
			'msg'			=> $param['memo']
		);

		$this->oordercreate->insert_tempmsg($ordermsg);
	}

	function update_order_price($param){
		$order_info  = OrderData::get_order_data($this->adminuser,$param['ordernum'], $this->localdb);
		$order_price = new OrderPrice($this->adminuser, $param['ordernum']);
		$order_price->act_bankpay($order_info['cal_price'], NULL);
	}

	function update_stock_count($param){
		$oodata_baskets = OrderData::get_basket_datas($this->adminuser, $param['ordernum'], $this->localdb);
		foreach ($oodata_baskets as $k => $value) {
			if ($value['basket_status'] == "S11" || $value['basket_status'] == "D11") { //결제 대기만 넘김
				$arr_basket_num[] = $k;
				$log_arr_basket_num[] = $k;
			}
			//로깅
			if (count($log_arr_basket_num) > 0) {
				$str_arr_basket_num = implode(',', $log_arr_basket_num);
				$message = "주문번호 : {$ordernum} / num : {$str_arr_basket_num} / 동작일 : ".date("YmdHis")." / 관리자 입금완료";
				savelogs($message);
			}

			// 상품 주문수 증가(+)
			$sql2 = <<<SQL
					UPDATE `product` as `p`
					SET `p`.`sellcount` = `p`.`sellcount` + {$value['basket_stock']},
						`p`.`selldate` = NOW()
					 WHERE `p`.`adminuser` = '{$this->adminuser}' AND `p`.`uid` = '{$value['product_uid']}'
SQL;
			$result2 = query($sql2, $this->localdb);
		}
		// 재고 차감
		$result_return =  OOStock::set_stock($this->adminuser, $param['ordernum'], $arr_basket_num, '-');
		if (count($result_return[1]) > 0) {
			$save_log_text = "상품 수량 차감 완료([".implode('],[', $result_return[1])."])";//재고처리 한 리스트를 만들어 놓는다.
		} else {
			$save_log_text = "상품 수량 차감 없음";
		}
		$logstr = '관리자 입금완료';
		updatelogs($param['ordernum'], '['.$logstr.'] : '.$save_log_text);
	}

	function define_set_order_data($param)
	{
		return array(
			'start_price'       => $param['total_order_price'],
			'cal_price'         => $param['total_pay_price'],
			'deli_price'		=>$param['deli_price'],
			'order_date'        => $param['order_date'],
			'order_status'      => 'Y',
			'etctype'			=> 'PAYMENTSTOCK=PAY',
			'link_id'           => $param['link_id'],
			'group_id'          => $users['group_id'],
		);
	}

	function define_product($basket)
	{
		$productObj = new Product($this->adminuser);
		$productObj->set_uid($basket['product_uid']);
		$products = (array) $productObj->get();
		$options = $this->define_product_option($basket['product_uid'], $basket['prd_option_uid']);
		if($basket['price'] != 0) $this->deposit_passible = false;
		return array(
			'product_uid'       => ($products['uid'])?$products['uid']:"999999",
			'prd_option_uid'    => $basket['prd_option_uid'],
			'brandcode'         => $products['brandcode'],
			'product_name'      => strlen($basket['product_name']) ? $basket['product_name'] : $products['brandname'],
			'basket_stock'      => ($basket['stock']) ? $basket['stock'] : 1,
			'product_price'     => $basket['price'],
			'product_buyprice'  => $products['buyprice'],
			'product_cate1'     => substr($products['brandcode'], 0, 3),
			'sell_price'        => $basket['price']*$basket['stock'],
			'product_reserve'   => strlen($basket['reserve']) ? $basket['reserve'] : 0,
			'option_data'       => $options['option_data'],
			'api_option_data'   => $options['option_data'],
			'option_type'       => $options['option_type'],
			'provider'          => $products['provider'],
		);
	}

	function define_product_option($product_uid, $sto_id)
	{
		$ProductOption = new ProductOption($this->adminuser, $product_uid);
		$options = $ProductOption->get();
		$sto_price = 0;
		$prd_option_uid = $option_data = '';
		$option_type = $products['option_type'];
		if ($option_type != 'DIY' && $option_type != 'HYBRID') {
			$option_type = $ProductOption->is_exist() === true ? 'PS' : 'NO';
		}
		for ($j=0; $j<count($options['stock']); $j++) {
			if ($options['stock'][$j]->sto_id == $sto_id) {
				$opt_ids = explode(",", $options['stock'][$j]->opt_ids);
				$opt_values = explode(",", $options['stock'][$j]->opt_values);
				$sto_price = $options['stock'][$j]->sto_price;
				$prd_option_uid = $options['stock'][$j]->sto_id;
				$option_type = $options['stock'][$j]->sto_type;
				break;
			}
		}

		$option_data = '';
		$optIdx = 0;
		for ($j=0; $j<count($options['option']); $j++) {
			if (is_array($opt_ids) && in_array($options['option'][$j]->opt_id, $opt_ids)) {
				$option_data .= "{$options['option'][$j]->opt_name} : {$opt_values[$optIdx]}, ";
				$optIdx++;
			}
		}
		$option_data = substr($option_data, 0, -2);

		if ($sto_price > 0) {
			$option_data .= "(+{$sto_price})";
		} else if ($sto_price < 0) {
			$option_data .= "(-{$sto_price})";
		}
		return array(
			'option_data' => $option_data,
			'option_type' => $option_type
		);
	}

	//y 확인후 수정 필요
	function define_user($param)
	{
		$user_id = $param['user_id'];
		$users = $this->find_by_userid($user_id);
		$is_user = is_array($users) && $users['dormant'] === 'N' && $users['id'] === $user_id ? true : false;
		return array(
			'is_user' => $is_user,
			'user_id' => $users['id'],
			'group_id' => $is_user ? $users['group_id']:'',
			'reserve' => $is_user ? $users['reserve'] : $param['receiver'],
			'sender' => $is_user ? $users['hname'] : $param['sender'],
			'phone' => $is_user ? $users['hphone'] : $param['phone'],
			'mobile' => $is_user ? $users['etcphone'] : $param['mobile'],
			'email' => $is_user ? $users['email'] : $param['email'],
		);
	}

	function create_add_fields($param)
	{
		require_once "{$_ENV['PATH_FUNC']}/create_tempid.func.html";
		$tempid = create_tempid();
		$etc = $this->etcInformation();
	return array(
			'tempid' => $tempid,
			'ordernum' => gen_ordernum(),
			'delivery_num' => gen_deliverynum(),
			'barcode' => $this->make_barcode($etc['order_max_barcode']),
			'paymethod' => $param['paymethod'],
			'basket_status' => 'D13',
			'date' => date('YmdHis'),
			'order_date' => date('Y-m-d H:i:s'),
			'link_id' => $param['link_id']
		);
	}

	function make_barcode($order_max_barcode)
	{
		$maxcode = "";
		$date = date('Ymd');
		if (substr("2".$order_max_barcode, 0, 8) == $date) {
			$maxcode = $order_max_barcode;
		}
		return strlen($maxcode) == 0 ? substr($date, 1)."00001" : substr($date, 1).substr("0000".(substr($maxcode, -5) + 1), -5);
	}


}

